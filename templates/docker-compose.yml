version: '3.4'
services:
  proxy:
    image: nginx:latest
    container_name: proxy
    restart: always
    volumes:
      - /home/{{host_user}}/proxy/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /home/{{host_user}}/proxy/nginx/conf.d:/etc/nginx/conf.d
      - /home/{{host_user}}/proxy/nginx/sites-enabled:/etc/nginx/sites-enabled
      - /var/www/html:/usr/share/nginx/html
      - /var/log/nginx:/var/log/nginx
      - /home/{{host_user}}/proxy/certs/{{project}}/public.key:/etc/ssl/certs/public.key
      - /home/{{host_user}}/proxy/certs/{{project}}/private.key:/etc/ssl/private/private.key
    ports:
      - "80:80"
      - "443:443"
    networks:
      teamcity:
        ipv4_address: 192.168.176.80
  server:
    container_name: server
    image: jetbrains/teamcity-server:2023.11.4
    restart: always
    environment:
      TEAMCITY_SERVER_MEM_OPTS: "-Xmx2048m" # Limit memory usage
    ports:
      - "8111:8111"
    networks:
      wrkng:
        ipv4_address: 192.168.176.81
    volumes:
      - volume_server_data:/data/teamcity_server/datadir
      - volume_server_logs:/opt/teamcity/logs
      - /home/{{host_user}}/server-files/server.xml:/opt/teamcity/conf/server.xml
      - /home/{{host_user}}/server-files/server.database.properties:/data/teamcity_server/datadir/config/database.properties
  agent_zero:
    container_name: agent_zero
    restart: always
    build:
      context: /home/{{host_user}}/agent-files
      dockerfile: agent.zero.Dockerfile
      network: host
    networks:
      wrkng:
        ipv4_address: 192.168.176.60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/{{host_user}}/agent-files:/home/buildagent/agent-files
    environment:
      SERVER_URL: http://server:8111
      AGENT_NAME: agent_zero
      DOCKER_IN_DOCKER: start
    privileged: true
    user: root
  agent_one:
    container_name: agent_one
    restart: always
    build:
      context: /home/{{host_user}}/agent-files
      dockerfile: agent.zero.Dockerfile
      network: host
    networks:
      wrkng:
        ipv4_address: 192.168.176.61
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/{{host_user}}/agent-files:/home/buildagent/agent-files
    environment:
      SERVER_URL: http://server:8111
      AGENT_NAME: agent_one
      DOCKER_IN_DOCKER: start
    privileged: true
    user: root
  pgadmin4:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: {{pgadmin_admin_email}}
      PGADMIN_DEFAULT_PASSWORD: {{pgadmin_admin_password}}
      PGADMIN_LISTEN_PORT: 8080
    ports:
      - "8080:8080"
    volumes:
      - /home/{{host_user}}/pgadmin/servers.json:/pgadmin4/servers.json
    networks:
      wrkng:
        ipv4_address: 192.168.176.33
  strapi:
    image: elestio/strapi-production:latest
    container_name: strapi
    restart: always
    environment:
      DATABASE_CLIENT: postgres
      NODE_ENV: production
      ADMIN_PASSWORD: {{strapi_admin_password}}
      ADMIN_EMAIL: {{strapi_admin_email}}
      BASE_URL: {{strapi_base_url}}
      SMTP_HOST: {{strapi_smtp_host}}
      SMTP_PORT: {{strapi_smtp_port}}
      SMTP_AUTH_STRATEGY: {{strapi_smtp_auth_strategy}}
      SMTP_FROM_EMAIL: {{strapi_smtp_from_email}}
      DATABASE_USERNAME: {{postgresql_user_two}}
      DATABASE_PASSWORD: {{postgresql_password_two}}
      DATABASE_HOST: {{postgresql_host}}
      DATABASE_PORT: {{postgresql_port}}
      DATABASE_NAME: {{postgresql_database_two}}
      JWT_SECRET: {{strapi_jwt_secret}}
      ADMIN_JWT_SECRET: {{strapi_admin_jwt_secret}}
      APP_KEYS: {{strapi_app_keys}}
      API_TOKEN_SALT: {{strapi_api_token_salt}}
      TRANSFER_TOKEN_SALT: {{strapi_transfer_token_salt}}
    volumes:
      - /home/{{host_user}}/strapi/config:/opt/app/config
#      - /home/{{host_user}}/strapi/src:/opt/app/src
      - /home/{{host_user}}/strapi/package.json:/opt/package.json
      - /home/{{host_user}}/strapi/yarn.lock:/opt/yarn.lock
      - /home/{{host_user}}/strapi/.env:/opt/app/.env
      - /home/{{host_user}}/strapi/public/uploads:/opt/app/public/uploads
      - /home/{{host_user}}/strapi/entrypoint.sh:/opt/app/entrypoint.sh
    ports:
      - "1337:1337"
    networks:
      wrkng:
        ipv4_address: 192.168.176.83
networks:
  wrkng:
    ipam:
      driver: default
      config:
        - subnet: "192.168.176.0/20"
#  teamcity:
#    ipam:
#      driver: default
#      config:
#        - subnet: "192.168.176.0/20"
#  strapi:
#    ipam:
#      driver: default
#      config:
#        - subnet: "192.168.208.0/20"
#  pgadmin:
#    ipam:
#      driver: default
#      config:
#        - subnet: "192.168.128.0/20"
volumes:
  volume_server_data:
    external: true
  volume_server_logs:
    external: true
  volume_agent:
    external: true
#  volume_postgresql:
#    external: true
